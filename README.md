
# üì¶ Cr√©er un Bot Telegram avec Python ‚Äì Documentation Compl√®te

Bas√©e sur l‚Äôarticle de Moraneus : [Building Telegram Bot with Python](https://medium.com/@moraneus/building-telegram-bot-with-python-telegram-bot-a-comprehensive-guide-7e33f014dc79)

---

## üå± 1. Pr√©parer l‚Äôenvironnement

- **Cr√©er un environnement virtuel**  
  ```bash
  python3 -m venv venv
  source venv/bin/activate
  ```

- **Installer les d√©pendances**  
  ```bash
  pip install -r requirements.txt
  ```

---

## ü§ñ 2. Cr√©er votre bot Telegram

1. Ouvrir Telegram et rechercher **BotFather**
2. Envoyer la commande `/newbot`
3. Choisir un nom et un @username pour votre bot
![bot father chat]('C:\Users\7MAKSACOD PC\PycharmProjects\python_telegram_bot\Capture d'√©cran 2025-06-13 181608.png')
4. **Copier le token** donn√© par BotFather 
5. Cr√©er un fichier .env et inserer la paire cl√©-valeur:
```
TOKEN="7687267672:AAGHEtsFh4H8WAqCfPgL67_V48UVZugZ7eg"
```

---

## üíª 3. √âcrire le code du bot

Passons maintenant au codage du bot. Veuillez cr√©er un nouveau fichier Python, par exemple : ```my_telegram_bot``` et ouvrez-le dans votre √©diteur de texte pr√©f√©r√©. Suivez ensuite ces √©tapes pour cr√©er votre bot.

### Importer des biblioth√®ques :

Commencez par importer les modules n√©cessaires et configurer la journalisation pour faciliter le d√©bogage :

```python
import logging
from telegram import (ReplyKeyboardMarkup, ReplyKeyboardRemove, Update, InlineKeyboardButton, InlineKeyboardMarkup)
from telegram.ext import (Application, CallbackQueryHandler, CommandHandler, ContextTypes, ConversationHandler, MessageHandler, filters)

logging.basicConfig(format='%(asctime)s - %(name)s - %(levelname)s - %(message)s', level=logging.INFO)
logger = logging.getLogger(__name__)
```

### D√©finir les √©tats de conversation

Les √©tats d‚Äôun bot Telegram, notamment lorsqu‚Äôun gestionnaire de conversations est utilis√©, servent de cadre pour g√©rer le flux d‚Äôinteraction entre le bot et l‚Äôutilisateur. Il s‚Äôagit essentiellement de marqueurs ou de points de contr√¥le qui d√©finissent la partie de la conversation actuellement engag√©e par l‚Äôutilisateur et d√©terminent la prochaine action du bot en fonction de ses informations.

Voici un aper√ßu plus g√©n√©ral du r√¥le et des fonctionnalit√©s des √©tats dans la gestion des conversations des bots. Leurs objectifs et fonctionnalit√©s dans le bot Telegram sont les suivants :

---

#### 1. Gestion s√©quentielle des flux

Les √©tats permettent au bot de g√©rer un flux de conversation s√©quentiel. En passant d‚Äôun √©tat √† un autre, le bot peut guider l‚Äôutilisateur √† travers une s√©rie d‚Äô√©tapes, de questions ou d‚Äôoptions dans un ordre logique.

---

#### 2. Connaissance du contexte

Ces informations aident le robot √† maintenir le contexte d‚Äôune conversation. En connaissant l‚Äô√©tat actuel, le robot comprend les informations fournies par l‚Äôutilisateur et celles qui sont encore n√©cessaires, ce qui lui permet de r√©agir de mani√®re appropri√©e.

---

#### 3. Traitement des saisies utilisateur

Selon l‚Äô√©tat actuel, le bot peut traiter les saisies utilisateur diff√©remment.  
Par exemple, une saisie `<CAR_TYPE>` sera interpr√©t√©e comme une indication du type de voiture √† vendre, tandis qu‚Äôune saisie `<CAR_COLOR>` sera interpr√©t√©e comme la couleur de la voiture.

---

#### 4. Impl√©mentation de la logique conditionnelle

Les √©tats permettent d‚Äôimpl√©menter une logique conditionnelle dans la conversation.  
En fonction des r√©ponses ou des choix de l‚Äôutilisateur, le bot peut d√©cider d‚Äôignorer certains √©tats, de les r√©p√©ter ou d‚Äôorienter l‚Äôutilisateur vers un autre chemin de conversation.

---

#### 5. Gestion des erreurs et r√©p√©tition

Ils facilitent la gestion des erreurs et la r√©p√©tition des questions si l‚Äôutilisateur fournit des r√©ponses inexactes ou invalides.  
En suivant l‚Äô√©tat actuel, le bot peut relancer l‚Äôutilisateur pour obtenir les informations correctes.

---

#### 6. Persistance de l‚Äô√©tat

Dans les bots plus complexes, les √©tats peuvent √™tre stock√©s et conserv√©s d‚Äôune session √† l‚Äôautre, permettant aux utilisateurs de reprendre la conversation l√† o√π ils l‚Äôavaient laiss√©e, m√™me s‚Äôils quittent temporairement le chat ou si le bot red√©marre.


---

√ânum√©rons les √©tats pour que notre bot g√®re le flux :

```python
TYPE_VOITURE, COULEUR_VOITURE, D√âCISION_KILOM√âTRAGE_VOITURE, KILOM√âTRAGE_VOITURE, PHOTO, R√âSUM√â = plage ( 6 )
```

## üîÅ 4. Ajouter des fonctionnalit√©s de conversation

Les gestionnaires de conversation des bots Telegram, notamment gr√¢ce √† des biblioth√®ques comme `python-telegram-bot`, sont des outils puissants qui g√®rent le flux des conversations en fonction des saisies utilisateur et d‚Äô√©tats pr√©d√©finis. Ils sont essentiels au d√©veloppement de bots n√©cessitant une s√©quence d‚Äôinteractions, comme la collecte d‚Äôinformations, le guidage des utilisateurs dans les menus ou l‚Äôex√©cution de commandes dans un ordre pr√©cis.

Voici un aper√ßu d√©taill√© du fonctionnement des gestionnaires de conversation et de leur r√¥le dans le d√©veloppement de bots :

---

### Objectif et fonctionnalit√©

#### 1. Gestion des √©tats conversationnels

Les gestionnaires de conversation suivent l‚Äô√©tat actuel du dialogue avec chaque utilisateur. Ils d√©terminent la prochaine action du bot en fonction des informations saisies par l‚Äôutilisateur et de l‚Äô√©tat actuel, permettant une progression fluide et logique des diff√©rentes √©tapes de l‚Äôinteraction.

---

#### 2. Routage des entr√©es utilisateur

Ces entr√©es sont achemin√©es vers diff√©rentes fonctions de rappel en fonction de l‚Äô√©tat actuel. Cela signifie qu‚Äôune m√™me entr√©e peut produire des r√©sultats diff√©rents selon la position de l‚Äôutilisateur dans la conversation.

---

#### 3. Gestion des commandes et du texte

Les gestionnaires de conversation peuvent faire la diff√©rence entre les commandes (comme `/start` ou `/help`) et les messages texte classiques, permettant aux d√©veloppeurs de sp√©cifier des r√©ponses ou des actions distinctes pour chaque type d‚Äôentr√©e.

---

#### 4. Int√©gration avec les claviers et les boutons

Ils fonctionnent parfaitement avec les claviers personnalis√©s et les boutons int√©gr√©s, permettant aux d√©veloppeurs de cr√©er des interfaces interactives et conviviales au sein de la conversation.  
Les utilisateurs peuvent s√©lectionner des options ou naviguer parmi les fonctionnalit√©s du bot gr√¢ce √† ces √©l√©ments d‚Äôinterface.

---

#### 5. Fonctions de repli et d‚Äôexpiration

Les gestionnaires de conversation prennent en charge les fonctions de repli, qui peuvent √™tre d√©clench√©es lorsque l‚Äôutilisateur entre une entr√©e inattendue ou lorsque la conversation doit √™tre r√©initialis√©e.  
Ils peuvent √©galement g√©rer les expirations, mettant fin automatiquement √† une conversation apr√®s une p√©riode d‚Äôinactivit√©.

La mise en ≈ìuvre d‚Äôun gestionnaire de conversation implique g√©n√©ralement la d√©finition de **points d‚Äôentr√©e**, d‚Äô**√©tats** et de **solutions de secours** :

- **Points d‚Äôentr√©e** :  
  Ce sont des d√©clencheurs qui lancent la conversation.  
  G√©n√©ralement, la commande `/start` est utilis√©e comme point d‚Äôentr√©e, mais vous pouvez d√©finir plusieurs points d‚Äôentr√©e pour diff√©rents flux de conversation.

- **√âtats** :  
  Comme indiqu√© pr√©c√©demment, les √©tats repr√©sentent diff√©rents points de la conversation.  
  Chaque √©tat est associ√© √† une ou plusieurs fonctions de rappel qui d√©finissent le comportement du bot √† ce stade.  
  Les d√©veloppeurs associent les √©tats √† ces fonctions de rappel, dictant ainsi le d√©roulement de la conversation.

- **Fonctions de secours** :  
  Les fonctions de secours sont d√©finies pour g√©rer les situations impr√©vues ou pour permettre de quitter ou de r√©initialiser la conversation.  
  Une fonction de secours courante est une commande `/cancel` permettant aux utilisateurs d‚Äôinterrompre la conversation √† tout moment.

Ensuite, la fonction ```start``` de gestionnaire initie la conversation (point d'entr√©e), pr√©sentant √† l'utilisateur une s√©lection de types de voitures :


```python
def  start ( update: Update, context: ContextTypes.DEFAULT_TYPE ) -> int : 
    """D√©marre la conversation et demande √† l'utilisateur quel est son type de voiture pr√©f√©r√©."""
     reply_keyboard = [[ 'Berline' , 'SUV' , 'Sports' , '√âlectrique' ]] 

    await update.message.reply_text( 
        '<b>Bienvenue dans le bot de vente de voitures !\n' 
        'Obtenons quelques d√©tails sur la voiture que vous vendez.\n' 
        'Quel est votre type de voiture ?</b>' , 
        parse_mode= 'HTML' , 
        reply_markup=ReplyKeyboardMarkup(reply_keyboard, one_time_keyboard= True , resize_keyboard= True ), 
    ) 

    return CAR_TYPE
```

Pour une interaction plus pouss√©e avec l‚Äôutilisateur :

- D√©finir des **√©tats** (ex. `CAR_TYPE`, `CAR_COLOR`, ‚Ä¶)
- Utiliser `ConversationHandler` pour guider l'utilisateur √©tape par √©tape

---

## ‚ñ∂Ô∏è 5. Lancer le bot

```bash
source venv/bin/activate
python bot.py
```

- Le bot sera actif
- Vous pouvez tester `/start` et envoyer du texte depuis Telegram

---

## üéØ 6. Tester et it√©rer

- Ajouter plus de **CommandHandler** pour d‚Äôautres commandes
- Utiliser **MessageHandler** pour g√©rer d'autres types de messages (photos, documents, etc.)

---

## üöÄ 7. Aller plus loin

- Int√©gration de claviers inline
- Connexion √† des APIs externes
- H√©bergement sur un serveur avec webhook
- Gestion des erreurs, logs, base de donn√©es

---

## üìù R√©sum√© des √©tapes

| √âtape                 | Description |
|----------------------|-------------|
| 1. Environnement      | Cr√©ation d‚Äôun venv + `pip install` |
| 2. Bot Telegram       | Cr√©ation via BotFather |
| 3. Code initial       | CommandHandler, MessageHandler |
| 4. ConversationHandler| Gestion d‚Äô√©tats |
| 5. Ex√©cution          | `python bot.py` |
| 6. Extensions         | Plus de fonctionnalit√©s |
| 7. D√©ploiement        | Webhook, serveur, persistance |

---

Bonne cr√©ation de bot ! üöÄ
